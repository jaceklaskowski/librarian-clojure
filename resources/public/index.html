<!--
   - Heavily inspired by https://github.com/tvaughan/mametipsum
   -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Librarian</title>
<link rel="stylesheet" href="css/bootstrap-2.0.1.min.css">
<style type="text/css">
body {
	padding-top: 10px;
}

body,textarea,.topbar input {
	font-family: "Droid Sans", "Helvetica Neue", Helvetica, Arial,
		sans-serif;
}
</style>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700">
<script src="js/jquery-1.7.1.min.js"></script>
<script src="ember-0.9.3.min.js"></script>
<script src="js/bootstrap-2.0.1.min.js"></script>
<script>
function appendBook(row, book) {
	row.append('<td>' + book._id + '</td>');
	row.append('<td>' + book["author"] + '</td>');
	row.append('<td>' + book["title"] + '</td>');
	var buttons = $('<td>');
	buttons.append('<a href="#" class="btn btn-primary"><i class="icon-pencil icon-white"></i> Edit</a>');
	buttons.append(' '); // FIXME: Use CSS padding instead of whitespace?
	buttons.append('<a href="#" class="btn btn-danger"><i class="icon-trash icon-white"></i> Delete</a>');
	row.append(buttons);
}

function validateBook(author, title) {
	var errorMsg = '';
	if(author.length == 0) {
		errorMsg += 'Author is missing\n';
	}
	if(title.length == 0) {
		errorMsg += 'Title is missing\n';
	}
	if(errorMsg.length > 0) {
		alert(errorMsg);
	}
	return errorMsg.length == 0;
}

function performSave(author, title, row) {
	$.ajax('/books', {
		type: 'PUT',
		data: {"author": author, "title": title},
		dataType: 'json',
		success: function(book) {
			row.empty();
			appendBook(row, book);
		}
	});
}

function saveNewBook(row) {
	return function() {
		var authorInput = row.find('input[name="author"]');
		var author = authorInput.val().trim();
		
		var titleInput = row.find('input[name="title"]');
		var title = titleInput.val().trim();
		
		var button = row.find('button');
		
		if(validateBook(author, title)) {
			authorInput.attr('disabled', true);
			titleInput.attr('disabled', true);
			button.attr('disabled', true);
			button.text('Saving...');
			performSave(author, title, row);
		}
	};
}

function newBookClicked() {
	var row = $('<tr>');
	row.append('<td>');
	row.append('<td><input type="text" name="author" /></td>');
	row.append('<td><input type="text" name="title"/></td>');
	row.append('<td><button class="btn btn-success"><i class="icon-pencil icon-white"></i> Create</button></td>');
	
	var btn = row.find('button');
	btn.click(saveNewBook(row));

	$('.book-list').append(row);
}

$(document).ready(function() {
	$.getJSON('/books.json', function(json) {
		var bookTable = $('.book-list');
		$.each(json, function(key, val) {
			var row = $('<tr>');
			appendBook(row, val);
			bookTable.append(row);
		});
	});
	
	$('#btn-add-book').click(newBookClicked);
});
</script>
</head>
<body>
	<div class="container">
		<div class="page-header">
			<h1>
				<a href="/">Librarian-Clojure</a> <small>a small web application for managing books in Clojure</small>
			</h1>
		</div>
		<section id="main">
			<div class="row">
				<div class="span12">
					<h1>Book list</h1>
					<blockquote>
						<p>The screen shows the list of available books</p>
						<small>The Helper</small>
					</blockquote>
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Id</th>
								<th>Author</th>
								<th>Title</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody class="book-list">
						</tbody>
					</table>
					<p>
						<button class="btn btn-success" id="btn-add-book"><i class="icon-plus icon-white"></i> New Book</button>
					</p>
				</div>
			</div>
		</section>
		<footer>
			<iframe src="http://bit.ly/zEZrRH" allowtransparency="true" frameborder="0" scrolling="0" width="132px" height="20px"></iframe>
			<div class="pull-right">
				<a href="https://github.com/jaceklaskowski/librarian-clojure">Join the project librarian-clojure on GitHub</a>
			</div>
		</footer>
	</div>
</body>
</html>